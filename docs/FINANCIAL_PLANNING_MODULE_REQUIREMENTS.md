# 理财模块需求文档

## 1. 文档概述

### 1.1 文档目的

本文档基于核心需求文件，详细分析和完善 ezBookkeeping 理财模块的需求，包括功能需求、非功能需求、数据模型设计、API设计、前端界面设计和集成方案，为后续开发提供指导。

### 1.2 术语定义

| 术语 | 解释 |
|------|------|
| 理财计划 | 用户制定的长期或短期财务目标和规划 |
| 投资组合 | 用户持有的各类投资资产的集合 |
| 净值 | 投资产品的当前价值 |
| 收益率 | 投资产品的收益与成本的比率 |
| 资产配置 | 投资组合中各类资产的分布比例 |
| 策略 | 用户预设的投资操作规则和提醒条件 |

## 2. 功能需求

### 2.1 数据导入导出优化

- **自动创建缺失实体**：导入数据时，自动创建缺失的账户、标签和账单分类
- **数据结构兼容性**：确保导入数据与现有数据结构兼容，支持不同类型资产的数据导入
- **测试数据管理**：提供便捷的测试数据导入导出功能，方便开发和测试环境使用

### 2.2 投资资产管理

- **多类型资产支持**：支持基金、股票、债券、房产等多种投资资产类型
- **资产基础信息**：为每种投资资产添加名称、代码、净值等基础信息
- **历史数据存储**：存储投资资产的历史数据（如基金每日净值、股票每日价格等）
- **资产交易记录**：记录投资资产的买入、卖出、分红等交易记录
- **数据兼容性**：设计兼容普通交易和投资资产交易的数据结构，支持未来扩展其他资产类型

### 2.3 理财与记账界面管理

- **界面切换**：在左上角添加切换功能，支持记账界面和理财界面的平滑切换
- **动画效果**：切换界面时添加流畅的动画效果，提升用户体验
- **功能分区**：记账界面偏向生活记账，理财界面偏向投资资产管理
- **统一登录**：共享用户认证状态，无需重复登录

### 2.4 投资数据分析

- **收益追踪**：支持日、周、月、年的收益追踪和分析
- **资产表现分析**：分析各类资产的表现，包括收益率、波动率等指标
- **资产配置分析**：分析投资组合的资产分布比例，提供资产配置建议
- **月报生成**：自动生成月度投资报告，汇总投资表现和建议
- **策略提醒**：根据用户预设的投资策略，提供操作提醒（如买入、卖出、调仓等）

### 2.5 智能功能

- **API 失效应对**：当外部 API 失效时，使用本地存储的历史数据提供基本分析
- **市场数据更新**：定期自动更新市场数据，确保数据时效性
- **投资建议**：基于用户的投资组合和市场情况，提供个性化投资建议
- **风险评估**：评估用户投资组合的风险水平，提供风险控制建议

### 2.6 扩展功能

- **投资目标管理**：设置投资目标，追踪目标达成进度
- **投资组合对比**：支持不同投资组合的性能对比
- **税务计算**：提供投资收益的税务计算功能
- **导出报告**：支持导出投资报告为 PDF、Excel 等格式
- **多账户管理**：支持管理多个投资账户，如证券账户、基金账户等

## 3. 非功能需求

### 3.1 性能需求

- **页面加载时间**：理财界面页面加载时间 < 2秒
- **数据更新延迟**：市场数据更新延迟 < 5秒
- **响应时间**：用户操作响应时间 < 1秒
- **并发处理**：支持同时处理1000+用户请求

### 3.2 安全需求

- **数据加密**：所有投资相关数据加密存储
- **API 鉴权**：投资数据 API 请求需要严格的鉴权和授权
- **数据备份**：支持投资数据的定期备份和恢复
- **隐私保护**：保护用户投资隐私，避免敏感数据泄露

### 3.3 可用性需求

- **系统可用性**：系统可用性 ≥ 99.9%
- **多语言支持**：与现有系统一致，支持多语言
- **多设备访问**：支持桌面和移动设备访问理财功能
- **离线访问**：支持基本的离线访问功能，如查看本地存储的历史数据

### 3.4 可扩展性需求

- **插件架构**：支持插件式架构，便于扩展新的投资资产类型
- **API 集成**：支持第三方金融数据 API 集成（如证券交易所 API、基金公司 API 等）
- **数据模型扩展**：设计可扩展的数据模型，支持未来新增资产类型
- **功能模块扩展**：支持独立扩展理财功能模块，不影响现有记账功能

## 4. 数据模型设计

### 4.1 现有数据模型扩展

#### 4.1.1 交易模型扩展

在现有交易模型中添加以下字段：
- `is_investment`: 布尔值，标识是否为投资交易
- `investment_type`: 字符串，投资类型（如：stock, fund, bond, real_estate 等）
- `investment_product_id`: 整数，关联投资产品 ID

#### 4.1.2 账户模型扩展

在现有账户模型中添加以下字段：
- `is_investment_account`: 布尔值，标识是否为投资账户
- `investment_account_type`: 字符串，投资账户类型（如：securities, fund, retirement 等）

### 4.2 新增数据模型

#### 4.2.1 投资产品模型 (investment_products)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `int64` | `PRIMARY KEY` | 产品 ID |
| `uid` | `int64` | `NOT NULL` | 用户 ID |
| `name` | `string` | `NOT NULL` | 产品名称 |
| `type` | `string` | `NOT NULL` | 产品类型（stock, fund, bond, real_estate 等） |
| `code` | `string` | | 产品代码（如股票代码、基金代码） |
| `current_value` | `decimal` | `NOT NULL` | 当前价值 |
| `cost_basis` | `decimal` | `NOT NULL` | 成本 |
| `quantity` | `decimal` | `NOT NULL` | 持有数量 |
| `current_price` | `decimal` | | 当前单价 |
| `currency` | `string` | `NOT NULL` | 货币类型 |
| `is_active` | `bool` | `NOT NULL` | 是否激活 |
| `created_at` | `datetime` | `NOT NULL` | 创建时间 |
| `updated_at` | `datetime` | `NOT NULL` | 更新时间 |

#### 4.2.2 投资产品历史数据模型 (investment_product_histories)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `int64` | `PRIMARY KEY` | 历史数据 ID |
| `product_id` | `int64` | `NOT NULL` | 投资产品 ID |
| `date` | `date` | `NOT NULL` | 日期 |
| `price` | `decimal` | `NOT NULL` | 当日价格/净值 |
| `volume` | `decimal` | | 当日成交量（如股票） |
| `created_at` | `datetime` | `NOT NULL` | 创建时间 |

#### 4.2.3 投资交易模型 (investment_transactions)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `int64` | `PRIMARY KEY` | 交易 ID |
| `uid` | `int64` | `NOT NULL` | 用户 ID |
| `product_id` | `int64` | `NOT NULL` | 投资产品 ID |
| `transaction_id` | `int64` | `NOT NULL` | 关联主交易 ID |
| `type` | `string` | `NOT NULL` | 交易类型（buy, sell, dividend, interest 等） |
| `quantity` | `decimal` | `NOT NULL` | 交易数量 |
| `price` | `decimal` | `NOT NULL` | 交易单价 |
| `fee` | `decimal` | | 交易费用 |
| `created_at` | `datetime` | `NOT NULL` | 创建时间 |

#### 4.2.4 投资组合模型 (investment_portfolios)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `int64` | `PRIMARY KEY` | 组合 ID |
| `uid` | `int64` | `NOT NULL` | 用户 ID |
| `name` | `string` | `NOT NULL` | 组合名称 |
| `description` | `string` | | 组合描述 |
| `is_default` | `bool` | `NOT NULL` | 是否为默认组合 |
| `created_at` | `datetime` | `NOT NULL` | 创建时间 |
| `updated_at` | `datetime` | `NOT NULL` | 更新时间 |

#### 4.2.5 投资策略模型 (investment_strategies)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `int64` | `PRIMARY KEY` | 策略 ID |
| `uid` | `int64` | `NOT NULL` | 用户 ID |
| `name` | `string` | `NOT NULL` | 策略名称 |
| `description` | `string` | | 策略描述 |
| `type` | `string` | `NOT NULL` | 策略类型（buy_low_sell_high, dollar_cost_averaging 等） |
| `conditions` | `json` | `NOT NULL` | 策略条件（JSON 格式） |
| `is_active` | `bool` | `NOT NULL` | 是否激活 |
| `created_at` | `datetime` | `NOT NULL` | 创建时间 |
| `updated_at` | `datetime` | `NOT NULL` | 更新时间 |

#### 4.2.6 投资提醒模型 (investment_alerts)

| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| `id` | `int64` | `PRIMARY KEY` | 提醒 ID |
| `uid` | `int64` | `NOT NULL` | 用户 ID |
| `strategy_id` | `int64` | | 关联策略 ID |
| `product_id` | `int64` | | 关联产品 ID |
| `type` | `string` | `NOT NULL` | 提醒类型（price_alert, strategy_alert 等） |
| `message` | `string` | `NOT NULL` | 提醒消息 |
| `is_read` | `bool` | `NOT NULL` | 是否已读 |
| `created_at` | `datetime` | `NOT NULL` | 创建时间 |
| `read_at` | `datetime` | | 阅读时间 |

## 5. API 设计

### 5.1 投资产品 API

| 路径 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/v1/investment-products` | `GET` | 获取投资产品列表 | 登录用户 |
| `/api/v1/investment-products/:id` | `GET` | 获取单个投资产品详情 | 登录用户 |
| `/api/v1/investment-products` | `POST` | 创建投资产品 | 登录用户 |
| `/api/v1/investment-products/:id` | `PUT` | 更新投资产品 | 登录用户 |
| `/api/v1/investment-products/:id` | `DELETE` | 删除投资产品 | 登录用户 |
| `/api/v1/investment-products/:id/histories` | `GET` | 获取投资产品历史数据 | 登录用户 |
| `/api/v1/investment-products/:id/transactions` | `GET` | 获取投资产品交易记录 | 登录用户 |

### 5.2 投资交易 API

| 路径 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/v1/investment-transactions` | `GET` | 获取投资交易列表 | 登录用户 |
| `/api/v1/investment-transactions` | `POST` | 创建投资交易 | 登录用户 |
| `/api/v1/investment-transactions/:id` | `DELETE` | 删除投资交易 | 登录用户 |

### 5.3 投资组合 API

| 路径 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/v1/investment-portfolios` | `GET` | 获取投资组合列表 | 登录用户 |
| `/api/v1/investment-portfolios/:id` | `GET` | 获取单个投资组合详情 | 登录用户 |
| `/api/v1/investment-portfolios` | `POST` | 创建投资组合 | 登录用户 |
| `/api/v1/investment-portfolios/:id` | `PUT` | 更新投资组合 | 登录用户 |
| `/api/v1/investment-portfolios/:id` | `DELETE` | 删除投资组合 | 登录用户 |
| `/api/v1/investment-portfolios/:id/statistics` | `GET` | 获取投资组合统计 | 登录用户 |
| `/api/v1/investment-portfolios/:id/assets` | `GET` | 获取投资组合资产 | 登录用户 |
| `/api/v1/investment-portfolios/:id/assets` | `POST` | 添加资产到投资组合 | 登录用户 |
| `/api/v1/investment-portfolios/:id/assets/:assetId` | `DELETE` | 从投资组合移除资产 | 登录用户 |

### 5.4 投资策略 API

| 路径 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/v1/investment-strategies` | `GET` | 获取投资策略列表 | 登录用户 |
| `/api/v1/investment-strategies/:id` | `GET` | 获取单个投资策略详情 | 登录用户 |
| `/api/v1/investment-strategies` | `POST` | 创建投资策略 | 登录用户 |
| `/api/v1/investment-strategies/:id` | `PUT` | 更新投资策略 | 登录用户 |
| `/api/v1/investment-strategies/:id` | `DELETE` | 删除投资策略 | 登录用户 |

### 5.5 投资提醒 API

| 路径 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/v1/investment-alerts` | `GET` | 获取投资提醒列表 | 登录用户 |
| `/api/v1/investment-alerts/:id` | `GET` | 获取单个投资提醒详情 | 登录用户 |
| `/api/v1/investment-alerts/:id/read` | `PUT` | 标记投资提醒为已读 | 登录用户 |
| `/api/v1/investment-alerts/read-all` | `PUT` | 标记所有投资提醒为已读 | 登录用户 |

### 5.6 投资分析 API

| 路径 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/v1/investment-analysis/performance` | `GET` | 获取投资表现分析 | 登录用户 |
| `/api/v1/investment-analysis/portfolio` | `GET` | 获取投资组合分析 | 登录用户 |
| `/api/v1/investment-analysis/asset-allocation` | `GET` | 获取资产配置分析 | 登录用户 |
| `/api/v1/investment-analysis/report` | `GET` | 获取投资报告 | 登录用户 |
| `/api/v1/investment-analysis/recommendations` | `GET` | 获取投资建议 | 登录用户 |

### 5.7 数据导入导出 API

| 路径 | 方法 | 功能 | 权限 |
|------|------|------|------|
| `/api/v1/data/export` | `GET` | 导出数据 | 登录用户 |
| `/api/v1/data/import` | `POST` | 导入数据 | 登录用户 |
| `/api/v1/data/import/preview` | `POST` | 预览导入数据 | 登录用户 |

## 6. 前端界面设计

### 6.1 桌面端界面

#### 6.1.1 界面切换功能

- **切换按钮**：在左上角添加记账/理财切换按钮
- **动画效果**：切换时添加平滑的滑动或淡入淡出动画
- **状态指示**：清晰指示当前所在界面
- **响应式设计**：适配不同屏幕尺寸

#### 6.1.2 理财主界面

- **资产概览**：显示总资产、今日收益、总收益等关键指标
- **资产分布**：饼图显示不同类型资产的分布比例
- **收益趋势**：折线图显示收益的日、周、月、年趋势
- **资产列表**：显示各类投资资产的详细信息
- **快捷操作**：提供快速添加资产、查看详情等操作按钮

#### 6.1.3 投资产品详情界面

- **基本信息**：显示产品名称、代码、类型等基本信息
- **历史走势**：图表显示产品历史价格/净值走势
- **交易记录**：显示该产品的所有交易记录
- **相关分析**：提供该产品的性能分析和建议
- **操作按钮**：提供买入、卖出、编辑等操作按钮

#### 6.1.4 投资组合界面

- **组合概览**：显示组合总价值、总收益等信息
- **资产构成**：显示组合内各类资产的构成比例
- **性能分析**：分析组合的历史表现
- **资产列表**：显示组合内的所有资产
- **调整按钮**：提供添加/移除资产、调整权重等操作

#### 6.1.5 投资分析界面

- **收益分析**：分析不同时间段的收益情况
- **资产分析**：分析各类资产的表现
- **风险评估**：评估投资组合的风险水平
- **报告生成**：生成投资报告
- **策略管理**：管理投资策略和提醒

### 6.2 移动端界面

- **底部导航**：底部导航栏添加理财选项
- **卡片式布局**：采用卡片式布局展示各项理财功能
- **手势操作**：支持滑动切换界面、下拉刷新等手势操作
- **响应式图表**：图表采用响应式设计，适配不同屏幕尺寸
- **简洁设计**：移动端界面保持简洁，重点突出核心功能

## 7. 集成方案

### 7.1 与现有系统集成

#### 7.1.1 认证与授权

- **复用现有认证**：复用现有的 JWT 认证机制
- **权限控制**：为理财相关 API 添加相应的权限控制
- **用户状态共享**：共享用户登录状态，无需重复登录

#### 7.1.2 数据存储

- **复用现有数据库**：复用现有的数据库连接
- **表结构扩展**：通过扩展现有表结构和添加新表来支持理财功能
- **数据迁移**：提供数据迁移工具，确保现有数据的平滑过渡

#### 7.1.3 国际化

- **复用现有框架**：复用现有的国际化框架
- **添加理财术语**：为理财相关术语添加多语言支持
- **本地化适配**：适配不同地区的金融术语和格式

#### 7.1.4 通知系统

- **复用现有机制**：复用现有的通知机制
- **理财提醒**：为投资提醒、策略触发等事件添加通知
- **多渠道通知**：支持应用内通知、邮件通知等多种通知方式

### 7.2 第三方 API 集成

#### 7.2.1 金融数据 API

- **多源集成**：集成多个金融数据 API 提供商（如 Alpha Vantage、新浪财经等）
- **故障切换**：当一个 API 失效时，自动切换到备用 API
- **数据缓存**：缓存 API 数据，减少 API 调用次数
- **历史数据存储**：将 API 获取的历史数据存储到本地数据库

#### 7.2.2 交易平台 API

- **券商 API**：集成主流券商的交易 API，支持直接下单
- **银行 API**：集成银行 API，支持资金转账
- **安全认证**：确保 API 调用的安全性，保护用户凭证

### 7.3 数据兼容性方案

#### 7.3.1 数据结构设计

- **扩展现有模型**：通过扩展现有交易模型，支持投资交易
- **通用字段**：设计通用字段，支持不同类型资产的基本信息
- **扩展字段**：使用 JSON 字段存储不同类型资产的特有信息
- **版本控制**：添加数据结构版本控制，支持未来扩展

#### 7.3.2 数据迁移

- **自动迁移**：提供自动数据迁移工具，确保现有数据的兼容性
- **备份机制**：在迁移前自动备份数据，防止数据丢失
- **验证机制**：迁移后验证数据的完整性和一致性

## 8. 实施计划

### 8.1 阶段划分

| 阶段 | 时间 | 主要工作 |
|------|------|----------|
| 需求分析与设计 | 2周 | 需求细化、数据模型设计、API 设计、界面设计 |
| 后端开发 | 4周 | 实现数据模型、API 接口、业务逻辑 |
| 前端开发 | 4周 | 实现桌面端和移动端界面、交互逻辑 |
| 数据集成 | 2周 | 集成第三方金融数据 API、实现数据导入导出 |
| 测试 | 2周 | 单元测试、集成测试、用户测试 |
| 部署与上线 | 1周 | 部署到测试环境、性能测试、正式上线 |

### 8.2 资源需求

- **后端开发人员**：2名
- **前端开发人员**：2名
- **测试人员**：1名
- **产品经理**：1名
- **UI/UX 设计师**：1名

## 9. 风险评估

### 9.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 第三方 API 稳定性 | 金融数据获取失败 | 集成多个 API 提供商、实现故障切换机制、缓存历史数据 |
| 数据量增长 | 查询性能下降 | 优化数据库查询、添加缓存机制、分区存储历史数据 |
| 复杂计算性能 | 财务分析计算耗时 | 实现异步计算、优化算法、使用缓存 |
| 数据安全 | 敏感金融数据泄露 | 加密存储敏感数据、加强 API 鉴权、定期安全审计 |

### 9.2 业务风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 用户接受度 | 功能使用率低 | 进行用户调研、优化界面设计、提供使用引导 |
| 功能复杂度 | 用户学习成本高 | 实现渐进式功能展示、提供帮助文档和教程 |
|  regulatory compliance | 违反金融监管要求 | 了解相关法规、咨询法律专家、实现合规功能 |
| 数据准确性 | 投资数据错误 | 多重数据验证、定期数据核对、提供手动修正机制 |

### 9.3 实施风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 项目延期 | 上线时间推迟 | 合理规划任务、定期监控进度、及时调整计划 |
| 资源不足 | 开发力量不足 | 提前评估资源需求、合理分配资源、考虑外包部分工作 |
| 技术债务 | 代码质量下降 | 坚持代码规范、定期代码审查、编写单元测试 |
| 集成困难 | 与现有系统集成失败 | 充分测试集成点、制定回滚计划、逐步集成 |

## 10. 验收标准

### 10.1 功能验收

- **核心功能**：所有核心理财功能均已实现并正常工作
- **数据兼容性**：支持普通交易和投资资产交易的数据兼容
- **界面切换**：记账和理财界面切换流畅，动画效果良好
- **数据导入导出**：支持数据导入导出，自动创建缺失实体
- **投资分析**：提供完整的投资分析功能，包括收益追踪、资产配置分析等

### 10.2 性能验收

- **页面加载**：理财界面页面加载时间 < 2秒
- **API 响应**：API 响应时间 < 500ms
- **数据更新**：市场数据更新延迟 < 5秒
- **并发处理**：支持 1000+ 并发用户

### 10.3 安全验收

- **数据加密**：敏感金融数据加密存储
- **API 安全**：API 调用均需鉴权，无未授权访问
- **漏洞扫描**：通过安全漏洞扫描，无严重漏洞
- **数据备份**：支持定期数据备份和恢复

### 10.4 用户体验验收

- **界面设计**：界面美观、直观，符合现代设计标准
- **操作流程**：操作流程简洁明了，用户易于理解
- **响应式**：适配不同设备和屏幕尺寸
- **帮助文档**：提供完整的使用帮助文档和教程

## 11. 后续规划

### 11.1 功能扩展

- **更多资产类型**：支持更多类型的投资资产，如加密货币、P2P 理财等
- **高级分析**：提供更高级的投资分析工具，如技术分析、基本面分析等
- **社交功能**：添加投资社区、投资组合分享等社交功能
- **智能投顾**：集成 AI 智能投顾功能，提供个性化投资建议

### 11.2 技术优化

- **性能优化**：持续优化系统性能，提升用户体验
- **架构升级**：根据业务发展，适时升级系统架构
- **新技术应用**：探索应用新技术，如区块链、机器学习等
- **安全增强**：持续加强系统安全性，保护用户数据

### 11.3 生态建设

- **API 开放**：开放 API，支持第三方应用集成
- **插件系统**：实现插件系统，支持功能扩展
- **合作伙伴**：与金融机构、数据提供商建立合作关系
- **用户社区**：建立用户社区，收集反馈和建议

### 11.4 市场推广

- **用户教育**：提供理财知识教育内容，帮助用户提升理财能力
- **营销活动**：开展针对性的营销活动，吸引新用户
- **用户激励**：设计用户激励机制，提高用户活跃度
- **品牌建设**：加强品牌建设，提升市场知名度

### 11.5 家庭共享功能

- **支持家庭共享理财功能**：允许多个家庭成员共享和管理家庭理财数据
- **权限管理**：为不同家庭成员设置不同的访问权限
- **数据隔离**：确保个人数据和家庭数据的适当隔离
- **共同目标**：支持设置家庭共同财务目标，如购房、教育等

---

**ezBookkeeping 理财模块** - 为个人财务管理提供全面的投资资产跟踪和分析功能